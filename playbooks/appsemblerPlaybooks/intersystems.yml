# Set up a user and SFTP-only group
# Create directories for download of reports
# SFTP_user_password must be set in server-vars.yml
# set up cronjobs for custom ISC reports

- include: dogwood_multiserver_deploy.yml

- name: "InterSystems reports setup"
  hosts: "edxapp-server"
  sudo: true
  vars:
    sftp_users: 
      cmcreportsftp: 
        pwd: "{{ CMC_SFTP_user_password }}"
        reports_dir: "{{EDXAPP_ENV_EXTRA['CMC_COURSE_COMPLETION_LOCAL_STORAGE_DIR'] }}"

    sftp_group: "filetransfer"
  tasks:
    - name: create SFTP group
      group: name={{ sftp_group }} state=present

    - name: create SFTP users
      user: "name={{ item.key }} password={{item.value.pwd}} groups={{ sftp_group }} shell=/sbin/nologin createhome=yes"
      with_dict: "{{ sftp_users }}"

    - name: change owner of SFTP user home dir to root
      file: >
        path="/home/{{ item.key }}"
        owner="root"
        state="directory"
      with_dict: "{{ sftp_users }}"

    - name: make reports subdirectories
      file: >
        path="/home/{{ item.key }}/{{ item.value.reports_dir }}"
        state=directory
        owner={{ item.key }}
        group=edxapp
        mode=0775
      with_dict: "{{ sftp_users }}"

  # would rather use blockinfile here but not present < ansible 2.0
  # these aren't working on GCloud VM and will kill your sshd and you will be locked out.
  # TODO: FIXME.  try lineinfile validate command, and sshd -t to test the config before restarting sshd
    - name: Update sshd config to force SFTP group to chrooted internal-sftp only
      sudo: True
      lineinfile: 
        dest: /etc/ssh/sshd_config
        line: "{{ item }}"
        validate: "sshd -t -f %s"
        backup: yes
      with_items: 
        - Match group {{sftp_group}}
        -   PasswordAuthentication yes
        -   ChrootDirectory %h
        -   X11Forwarding no
        -   AllowTcpForwarding no
        -   ForceCommand internal-sftp

    - name: check sshd config
      sudo: True
      shell: sshd -t
      register: sshd_check

    - debug: msg="This output of sshd -t should be empty... {{ sshd_check }}"

    - name: restart ssh
      service: name=ssh state=restarted
      sudo: True
      when: sshd_check.stdout == ""


    - name: cron job for generating reports (CMC)
      cron: >
        user=root
        name="{{ item.value.name }}"
        job="{{ item.value.cmd }}"
        minute="{{ item.value.minute }}"
        hour="{{ item.value.hour }}"
      with_dict: {
        "cmc": {
          "name": "ISC CMC course completion and access report every morning 8:00PM GMT",
          "minute": 0,
          "hour": 5,
          "cmd": "/edx/app/edxapp/venvs/edxapp/bin/python /edx/app/edxapp/edx-platform/manage.py lms cmc_course_completion --settings=aws > /dev/null 2>&1"
        }
      }

    - name: cron job for cleaning out old reports
      cron: >
        user=root
        name="Remove {{item.value.reports_dir}} csv files older than 7 days, each time after the report is run"
        job="find /home/{{ item.key }}/{{ item.value.reports_dir }}/ -mtime +7 -exec rm {} \;"
        minute="15"
        hour="5"
      with_dict: "{{ sftp_users }}"


  